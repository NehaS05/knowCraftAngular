<div class="chat-container">
  <div class="conversations-sidebar">
    <div class="conversations-header">
      <h3>Conversations</h3>
      <div class="header-buttons">
        <button class="refresh-btn" (click)="refreshConversations()" title="Refresh conversations">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
          </svg>
        </button>
        <button class="new-conversation-btn" (click)="createNewConversation()" title="New Conversation">+</button>
      </div>
    </div>

    <div class="search-box">
      <input 
        type="text" 
        placeholder="Search conversations..." 
        [(ngModel)]="searchQuery" />
    </div>

    <div class="conversation-list">
      <!-- Loading state -->
      <div *ngIf="isLoading && conversations.length === 0" class="loading-conversations">
        <div class="loading-spinner"></div>
        <p>Loading conversations...</p>
      </div>
      
      <!-- Empty state -->
      <div *ngIf="!isLoading && conversations.length === 0" class="empty-conversations">
        <p>No conversations yet. Start a new conversation!</p>
      </div>
      
      <!-- Conversations list -->
      <div 
        *ngFor="let conversation of filteredConversations" 
        class="conversation-item" 
        [class.active]="isConversationActive(conversation)"
        (click)="selectConversation(conversation)">
        <div class="conversation-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
        <div class="conversation-details">
          <div class="conversation-title">{{ conversation.title }}</div>
          <div class="conversation-preview">{{ getConversationPreview(conversation) }}</div>
          <div class="conversation-meta">
            <span class="conversation-time">{{ getConversationTime(conversation) }}</span>
            <span class="conversation-user" *ngIf="isCurrentUserAdmin() && conversation.userEmail">
              â€¢ {{ conversation.userEmail }}
            </span>
          </div>
        </div>
        <div class="conversation-actions">
          <button 
            class="delete-conversation-btn" 
            (click)="deleteConversation($event, conversation)"
            title="Delete conversation">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-main">
    <div class="chat-header">
      <div>
        <h2>{{ selectedConversation?.title || 'New Conversation' }}</h2>
        <p class="chat-status">
          Active conversation
          <span *ngIf="isCurrentUserAdmin() && selectedConversation?.userEmail" class="conversation-owner">
            â€¢ Owner: {{ selectedConversation?.userEmail }}
          </span>
        </p>
      </div>
    </div>

    <div class="messages-container" #messagesContainer>
      <!-- Loading messages with skeleton -->
      <div *ngIf="isLoading && currentMessages.length === 0" class="loading-messages">
        <div class="message-skeleton-container">
          <div class="message-skeleton ai-skeleton" *ngFor="let item of [1,2]">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-content">
              <div class="skeleton-line long"></div>
              <div class="skeleton-line medium"></div>
              <div class="skeleton-line short"></div>
            </div>
          </div>
          <div class="message-skeleton user-skeleton">
            <div class="skeleton-content">
              <div class="skeleton-line medium"></div>
              <div class="skeleton-line short"></div>
            </div>
            <div class="skeleton-avatar"></div>
          </div>
        </div>
        <div class="loading-text">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <p>Loading conversation...</p>
        </div>
      </div>
      
      <!-- Enhanced empty messages state -->
      <div *ngIf="!isLoading && currentMessages.length === 0 && !selectedConversation" class="empty-messages">
        <div class="empty-state">
          <div class="empty-illustration">
            <div class="chat-bubble-1">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
            </div>
            <div class="chat-bubble-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
            </div>
            <div class="sparkle sparkle-1">âœ¨</div>
            <div class="sparkle sparkle-2">ðŸ’¬</div>
          </div>
          <h3>Ready to chat?</h3>
          <p>Select a conversation from the sidebar or start a new one to begin your AI-powered conversation.</p>
          <div class="indexing-notice">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M12 6v6l4 2"></path>
            </svg>
            <span>Recently uploaded documents may take a few moments to become searchable.</span>
          </div>
          <div class="empty-actions">
            <button class="start-chat-btn" (click)="createNewConversation()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14m-7-7h14"></path>
              </svg>
              Start New Chat
            </button>
          </div>
        </div>
      </div>
      
      <!-- Messages with enhanced animations -->
      <div class="messages" *ngIf="currentMessages.length > 0">
        <div class="messages-scroll-area">
        <ng-container *ngFor="let message of currentMessages; let i = index; trackBy: trackByMessageId">
          <!-- User Message on the right -->
          <div 
            *ngIf="message.type === 'User'"
            class="message user-message"
            [class.message-enter]="true"
            [style.animation-delay]="i * 100 + 'ms'">
            <div class="message-wrapper">
              <div class="user-content">
                {{ message.content }}
              </div>
              <div class="message-meta">
                <div class="message-status">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
                <span class="message-time">{{ getTimeAgo(message.createdAt) }}</span>
              </div>
            </div>
            <div class="message-avatar user-avatar">
              <div class="avatar-glow"></div>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
          </div>

          <!-- AI Response on the left -->
          <div 
            *ngIf="message.type === 'AI'"
            class="message ai-message"
            [class.message-enter]="true"
            [style.animation-delay]="i * 100 + 'ms'">
            <div class="message-avatar ai-avatar">
              <div class="avatar-glow"></div>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 8V4H8"></path>
                <rect width="16" height="12" x="4" y="8" rx="2"></rect>
                <path d="M2 14h2"></path>
                <path d="M20 14h2"></path>
                <path d="M15 13v2"></path>
                <path d="M9 13v2"></path>
              </svg>
            </div>
            <div class="message-wrapper">
              <!-- Simplified Dual Response Layout -->
              <div class="dual-response-container" *ngIf="message.ragAnswer || message.azureAiAnswer">
                <!-- RAG Response -->
                <div class="response-section chatgpt-section">
                  <div class="response-header">
                    <div class="response-icon chatgpt-icon">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                      </svg>
                    </div>
                    <span class="response-title">Knowledge Base</span>
                  </div>
                  <div class="response-content">
                    {{ message.ragAnswer || 'No Knowledge Base response available' }}
                  </div>
                </div>

                <!-- Azure AI Response -->
                <div class="response-section kb-section">
                  <div class="response-header">
                    <div class="response-icon kb-icon">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M12 1v6m0 6v6"></path>
                        <path d="M1 12h6m6 0h6"></path>
                      </svg>
                    </div>
                    <span class="response-title">Azure AI</span>
                  </div>
                  <div class="response-content">
                    {{ message.azureAiAnswer || 'No Azure AI response available' }}
                  </div>
                </div>
              </div>

              <!-- Legacy content for backward compatibility -->
              <div class="single-response" *ngIf="message.content && !message.ragAnswer && !message.azureAiAnswer">
                {{ message.content }}
              </div>

              <div class="message-meta">
                <span class="message-time">{{ getTimeAgo(message.createdAt) }}</span>
                <div class="message-actions">
                  <button class="action-btn copy-btn" title="Copy message" (click)="copyMessage(message)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                      <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
        
        <!-- AI Typing Indicator -->
        <div *ngIf="isAiTyping" class="message ai-message typing-message">
          <div class="message-avatar ai-avatar">
            <div class="avatar-glow"></div>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8V4H8"></path>
              <rect width="16" height="12" x="4" y="8" rx="2"></rect>
              <path d="M2 14h2"></path>
              <path d="M20 14h2"></path>
              <path d="M15 13v2"></path>
              <path d="M9 13v2"></path>
            </svg>
          </div>
          <div class="message-wrapper">
            <div class="typing-indicator-bubble">
              <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
              <span class="typing-text">AI is thinking...</span>
            </div>
          </div>
        </div>
        
        <!-- Scroll to bottom indicator -->
        <div class="scroll-to-bottom" *ngIf="showScrollToBottom" (click)="scrollToBottomManual()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="7 13 12 18 17 13"></polyline>
            <polyline points="7 6 12 11 17 6"></polyline>
          </svg>
        </div>
        </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <input 
          type="text" 
          class="chat-input-field"
          placeholder="Ask a question..." 
          [(ngModel)]="newMessage"
          (keypress)="onKeyPress($event)"
          maxlength="1000" />
        <div class="input-actions">
          <button class="attach-btn" (click)="openUploadModal()" title="Attach file">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
          </button>
          <button 
            class="send-btn" 
            (click)="sendMessage()" 
            [disabled]="!newMessage.trim() || isLoading"
            title="Send message">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
      <div class="chat-footer">
        <span>Press Enter to send, Shift+Enter for new line</span>
        <span class="character-count" [class.warning]="newMessage.length > 900">
          {{ newMessage.length }}/1000
        </span>
      </div>
    </div>
  </div>
</div>

<!-- File Upload Modal -->
<div class="modal-overlay" *ngIf="showUploadModal" (click)="closeUploadModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Upload Files</h3>
      <button class="close-btn" (click)="closeUploadModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="upload-area" (click)="fileInput.click()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <p class="upload-text">Click to upload files</p>
        <p class="upload-hint">PDF, DOC, TXT, images (Max 10MB each)</p>
        <input 
          #fileInput 
          type="file" 
          multiple 
          accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif"
          (change)="onFileSelect($event)"
          style="display: none;" />
      </div>

      <div class="selected-files" *ngIf="selectedFiles.length > 0">
        <h4>Selected Files ({{ selectedFiles.length }})</h4>
        <div class="file-list">
          <div class="file-item" *ngFor="let file of selectedFiles; let i = index">
            <div class="file-info">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
              <div class="file-details">
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">{{ formatFileSize(file.size) }}</span>
              </div>
            </div>
            <button class="remove-file-btn" (click)="removeFile(i)" title="Remove file">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeUploadModal()">Cancel</button>
      <button class="btn-primary" (click)="uploadFiles()">Upload</button>
    </div>
  </div>
</div>