<div class="chat-container">
  <div class="conversations-sidebar">
    <div class="conversations-header">
      <h3>Conversations</h3>
      <div class="header-buttons">
        <button class="refresh-btn" (click)="refreshConversations()" title="Refresh conversations">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
          </svg>
        </button>
        <button class="new-conversation-btn" (click)="createNewConversation()" title="New Conversation">+</button>
      </div>
    </div>

    <div class="search-box">
      <input 
        type="text" 
        placeholder="Search conversations..." 
        [(ngModel)]="searchQuery" />
    </div>

    <div class="conversation-list">
      <!-- Loading state -->
      <div *ngIf="isLoading && conversations.length === 0" class="loading-conversations">
        <div class="loading-spinner"></div>
        <p>Loading conversations...</p>
      </div>
      
      <!-- Empty state -->
      <div *ngIf="!isLoading && conversations.length === 0" class="empty-conversations">
        <p>No conversations yet. Start a new conversation!</p>
      </div>
      
      <!-- Conversations list -->
      <div 
        *ngFor="let conversation of filteredConversations" 
        class="conversation-item" 
        [class.active]="isConversationActive(conversation)"
        (click)="selectConversation(conversation)">
        <div class="conversation-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
        </div>
        <div class="conversation-details">
          <div class="conversation-title">{{ conversation.title }}</div>
          <div class="conversation-preview">{{ getConversationPreview(conversation) }}</div>
          <div class="conversation-time">{{ getConversationTime(conversation) }}</div>
        </div>
        <div class="conversation-actions">
          <button 
            class="delete-conversation-btn" 
            (click)="deleteConversation($event, conversation)"
            title="Delete conversation">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-main">
    <div class="chat-header">
      <div>
        <h2>{{ selectedConversation?.title || 'New Conversation' }}</h2>
        <p class="chat-status">Active conversation</p>
      </div>
    </div>

    <div class="messages-container" #messagesContainer>
      <!-- Loading messages -->
      <div *ngIf="isLoading && currentMessages.length === 0" class="loading-messages">
        <div class="loading-spinner"></div>
        <p>Loading messages...</p>
      </div>
      
      <!-- Empty messages state -->
      <div *ngIf="!isLoading && currentMessages.length === 0 && !selectedConversation" class="empty-messages">
        <div class="empty-state">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
          </svg>
          <h3>Start a conversation</h3>
          <p>Select a conversation from the sidebar or create a new one to get started.</p>
        </div>
      </div>
      
      <div class="messages" *ngIf="currentMessages.length > 0">
        <ng-container *ngFor="let message of currentMessages">
          <!-- AI Message -->
          <div 
            *ngIf="!message.isUser"
            class="message ai-message">
            <div class="message-avatar">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot w-5 h-5"><path d="M12 8V4H8"></path><rect width="16" height="12" x="4" y="8" rx="2"></rect><path d="M2 14h2"></path><path d="M20 14h2"></path><path d="M15 13v2"></path><path d="M9 13v2"></path></svg>
            </div>
            <div class="message-wrapper">
              <!-- Dual Response Layout -->
              <div class="dual-response-container" *ngIf="message.chatGptResponse || message.knowledgeBaseResponse">
                <!-- ChatGPT Response -->
                <div class="response-column">
                  <div class="response-header">
                    <div class="response-icon chatgpt-icon">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                      </svg>
                    </div>
                    <span class="response-title">ChatGPT Response</span>
                  </div>
                  <div class="message-content chatgpt-response">
                    {{ message.chatGptResponse || 'No ChatGPT response available' }}
                  </div>
                </div>

                <!-- Knowledge Base Response -->
                <div class="response-column">
                  <div class="response-header">
                    <div class="response-icon kb-icon">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                      </svg>
                    </div>
                    <span class="response-title">Knowledge Base Response</span>
                  </div>
                  <div class="message-content kb-response">
                    {{ message.knowledgeBaseResponse || 'No Knowledge Base response available' }}
                  </div>
                </div>
              </div>

              <!-- Legacy content for backward compatibility -->
              <div class="message-content" *ngIf="message.content && !message.chatGptResponse && !message.knowledgeBaseResponse">
                {{ message.content }}
              </div>

              <div class="message-meta">
                <span class="message-time">{{ getTimeAgo(message.createdAt) }}</span>
              </div>
            </div>
          </div>

          <!-- User Message -->
          <div 
            *ngIf="message.isUser"
            class="message user-message">
            <div class="message-wrapper">
              <div class="message-content">
                {{ message.content }}
              </div>
              <div class="message-meta">
                <span class="message-time">{{ getTimeAgo(message.createdAt) }}</span>
                <!-- <span class="message-badge">INTERNAL</span> -->
              </div>
            </div>
            <div class="message-avatar">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <div class="chat-input-container">
      <div class="chat-input-wrapper">
        <input 
          type="text" 
          class="chat-input-field"
          placeholder="Ask a question..." 
          [(ngModel)]="newMessage"
          (keypress)="onKeyPress($event)"
          maxlength="1000" />
        <div class="input-actions">
          <button class="attach-btn" (click)="openUploadModal()" title="Attach file">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
          </button>
          <button 
            class="send-btn" 
            (click)="sendMessage()" 
            [disabled]="!newMessage.trim() || isLoading"
            title="Send message">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
      <div class="chat-footer">
        <span>Press Enter to send, Shift+Enter for new line</span>
        <span class="character-count" [class.warning]="newMessage.length > 900">
          {{ newMessage.length }}/1000
        </span>
      </div>
    </div>
  </div>
</div>

<!-- File Upload Modal -->
<div class="modal-overlay" *ngIf="showUploadModal" (click)="closeUploadModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Upload Files</h3>
      <button class="close-btn" (click)="closeUploadModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="upload-area" (click)="fileInput.click()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <p class="upload-text">Click to upload files</p>
        <p class="upload-hint">PDF, DOC, TXT, images (Max 10MB each)</p>
        <input 
          #fileInput 
          type="file" 
          multiple 
          accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif"
          (change)="onFileSelect($event)"
          style="display: none;" />
      </div>

      <div class="selected-files" *ngIf="selectedFiles.length > 0">
        <h4>Selected Files ({{ selectedFiles.length }})</h4>
        <div class="file-list">
          <div class="file-item" *ngFor="let file of selectedFiles; let i = index">
            <div class="file-info">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
              <div class="file-details">
                <span class="file-name">{{ file.name }}</span>
                <span class="file-size">{{ formatFileSize(file.size) }}</span>
              </div>
            </div>
            <button class="remove-file-btn" (click)="removeFile(i)" title="Remove file">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeUploadModal()">Cancel</button>
      <button class="btn-primary" (click)="uploadFiles()">Upload</button>
    </div>
  </div>
</div>